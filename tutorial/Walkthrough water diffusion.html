<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Walkthrough particle diffusing in water &mdash; WISE 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="WISE 0.1 documentation" href="../index.html" />
    <link rel="prev" title="Walkthrough 3C120" href="Walkthrough3C120.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Walkthrough3C120.html" title="Walkthrough 3C120"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">WISE 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="walkthrough-particle-diffusing-in-water">
<h1>Walkthrough particle diffusing in water<a class="headerlink" href="#walkthrough-particle-diffusing-in-water" title="Permalink to this headline">¶</a></h1>
<p>In this walkthrough we will explore the potentiel of WISE for the
analysis of micron-sized particles diffusing in water. We will use
images from
<a class="reference external" href="https://soft-matter.github.io/trackpy/tutorial/walkthrough.html">https://soft-matter.github.io/trackpy/tutorial/walkthrough.html</a>, detect
and track the particles, and compare our result to the one obtained by
the trackpy team.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="code python highlight-python"><div class="highlight"><pre>import os
import datetime
import numpy as np

import astropy.units as u

import wise
from wise import wiseutils, wisetasks
from libwise import imgutils, plotutils, nputils, profileutils, presetutils

%matplotlib gtk
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">ctx</span> <span class="o">=</span> <span class="n">wiseutils</span><span class="o">.</span><span class="n">AnalysisContext</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-data-configration">
<h2>Setting up the data configration:<a class="headerlink" href="#setting-up-the-data-configration" title="Permalink to this headline">¶</a></h2>
<p>The full data set is composed of 300 images. We will first analyse only
part of it. We use a k sigma estimator to estimate the noise level in
the images:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~/data/bulk_water&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_bg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nputils</span><span class="o">.</span><span class="n">k_sigma_noise_estimation</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pre_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
    <span class="n">img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">data</span>

<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">&quot;run001&quot;</span><span class="p">)</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">bg_fct</span> <span class="o">=</span> <span class="n">get_bg</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pre_process_fct</span> <span class="o">=</span> <span class="n">pre_process</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">projection_relative</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">ctx</span><span class="o">.</span><span class="n">select_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">&#39;data/*0[0-9][0-9].png&#39;</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Number of files selected: 20
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">view_all</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plotutils</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;winter_r&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-detection-configration">
<h2>Setting up the detection configration:<a class="headerlink" href="#setting-up-the-detection-configration" title="Permalink to this headline">¶</a></h2>
<p>We want to track only the most promeninent particles, and to control it
we set an high value for alpha_detection. Also the particles are
typically all of the same sizes, and the displacement from image to
image is small, so we can perform the analysis only on one scale of the
wavelet decomposition:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">min_scale</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">max_scale</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">exclude_noise</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">alpha_detection</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">alpha_threashold</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">ms_dec_klass</span> <span class="o">=</span> <span class="n">wise</span><span class="o">.</span><span class="n">WaveletMultiscaleDecomposition</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">detection_all</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">view_wds</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-matching-configration">
<h2>Setting up the matching configration:<a class="headerlink" href="#setting-up-the-matching-configration" title="Permalink to this headline">¶</a></h2>
<p>A reasonable maximum displacement from image to image is 5 pixels. For
this tests, we do not needs the extra features of ScaleMatcherMSCSC2,
and we can use the more simple and faster ScaleMatcherMSCI matcher:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">maximum_delta</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">mscsc2_smooth</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">ignore_features_at_border</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">method_klass</span> <span class="o">=</span> <span class="n">wise</span><span class="o">.</span><span class="n">ScaleMatcherMSCI</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">match_all</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">view_displacements</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">view_links</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">map_cmap</span><span class="o">=</span><span class="s">&#39;winter_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="assessing-the-results">
<h2>Assessing the results:<a class="headerlink" href="#assessing-the-results" title="Permalink to this headline">¶</a></h2>
<p>To assess the performance of WISE, we will now compare our results to
the one obtain by trackpy. We will first re run the matching with a more
complete data set:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">pre_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="n">img</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">data</span>

<span class="n">ctx</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pre_process_fct</span> <span class="o">=</span> <span class="n">pre_process</span>

<span class="n">ctx</span><span class="o">.</span><span class="n">select_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">&#39;data/*.png&#39;</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Number of files selected: 60
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">wisetasks</span><span class="o">.</span><span class="n">match_all</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</pre></div>
</div>
<p>The different plotting tasks of wise all have an option to save the plot
in a file. We will use it to view the trajectories of all the particles:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">presetutils</span><span class="o">.</span><span class="n">set_rc_preset</span><span class="p">(</span><span class="s">&#39;presentation&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)})</span>
<span class="n">wisetasks</span><span class="o">.</span><span class="n">view_links</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">save_filename</span><span class="o">=</span><span class="s">&#39;view_links_full.png&#39;</span><span class="p">,</span> <span class="n">min_link_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">map_cmap</span><span class="o">=</span><span class="s">&#39;winter_r&#39;</span><span class="p">)</span>
<span class="n">presetutils</span><span class="o">.</span><span class="n">set_rc_preset</span><span class="p">(</span><span class="s">&#39;display&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now to compare our result, we will use analysis method developed by
trackpy to obtain the mean square displacement of the particles. The
following will convert wise result data structure into one compatible
with trackpy:</p>
<div class="code python highlight-python"><div class="highlight"><pre>import trackpy as tp
import pandas as pd
from uncertainties import ufloat

data = wisetasks.get_velocities_data(ctx, min_link_size=40)

get_link_id = np.vectorize(lambda link_id: np.int(link_id[2:]))
frame = data[&#39;epoch&#39;].values
x = data[&#39;ra&#39;].values
y = data[&#39;dec&#39;].values
link_id = get_link_id(data[&#39;link_id&#39;].values)
data_tp = pd.DataFrame(np.array([x, y, frame, link_id]).T, columns=[&#39;x&#39;, &#39;y&#39;, &#39;frame&#39;, &#39;particle&#39;])
data_tp = data_tp.drop_duplicates()

%matplotlib inline
</pre></div>
</div>
<p>To make sure that the conversion was correctly done, we first plot the
particle trajectories:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tp</span><span class="o">.</span><span class="n">plot_traj</span><span class="p">(</span><span class="n">data_tp</span><span class="p">)</span>
</pre></div>
</div>
<img alt="tutorial/Walkthrough%20water%20diffusion_files/Walkthrough%20water%20diffusion_34_0.png" src="tutorial/Walkthrough%20water%20diffusion_files/Walkthrough%20water%20diffusion_34_0.png" />
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f96185c9290&gt;
</pre></div>
</div>
<p>This will remove the overall drift:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">compute_drift</span><span class="p">(</span><span class="n">data_tp</span><span class="p">)</span>
<span class="n">tm</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">subtract_drift</span><span class="p">(</span><span class="n">data_tp</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
<p>This will compute the mean squared displacement of each particle and
plot MSD vs. lag time:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">im</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">imsd</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="mi">100</span><span class="o">/</span><span class="mf">285.</span><span class="p">,</span> <span class="mi">24</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\langle \Delta r^2 \rangle$ [$\mu$m$^2$]&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="tutorial/Walkthrough%20water%20diffusion_files/Walkthrough%20water%20diffusion_38_0.png" src="tutorial/Walkthrough%20water%20diffusion_files/Walkthrough%20water%20diffusion_38_0.png" />
<p>And now we can compute the ensemble mean squared displacement and
compare it with the theoretical one:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c">#em = tp.emsd(tm, 100/285., 24/5.)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;ro&#39;</span><span class="p">)</span>

<span class="n">fit_fct</span> <span class="o">=</span> <span class="n">nputils</span><span class="o">.</span><span class="n">PowerFct1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">em</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">em</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plotutils</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">em</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">em</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit_fct</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;n = &quot;</span><span class="p">,</span> <span class="n">ufloat</span><span class="p">(</span><span class="n">fit_fct</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">fit_fct</span><span class="o">.</span><span class="n">ea</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;A = &quot;</span><span class="p">,</span> <span class="n">ufloat</span><span class="p">(</span><span class="n">fit_fct</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">fit_fct</span><span class="o">.</span><span class="n">eb</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>n =  1.0636+/-0.0024
A =  1.734+/-0.007
</pre></div>
</div>
<img alt="tutorial/Walkthrough%20water%20diffusion_files/Walkthrough%20water%20diffusion_40_1.png" src="tutorial/Walkthrough%20water%20diffusion_files/Walkthrough%20water%20diffusion_40_1.png" />
<p>Theory of particles diffusivity in water predict A = 1.74 and n = 1.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Walkthrough particle diffusing in water</a><ul>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#setting-up-the-data-configration">Setting up the data configration:</a></li>
<li><a class="reference internal" href="#setting-up-the-detection-configration">Setting up the detection configration:</a></li>
<li><a class="reference internal" href="#setting-up-the-matching-configration">Setting up the matching configration:</a></li>
<li><a class="reference internal" href="#assessing-the-results">Assessing the results:</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Walkthrough3C120.html"
                        title="previous chapter">Walkthrough 3C120</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/tutorial/Walkthrough water diffusion.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Walkthrough3C120.html" title="Walkthrough 3C120"
             >previous</a> |</li>
        <li><a href="../index.html">WISE 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Florent Mertens.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>